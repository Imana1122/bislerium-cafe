@page "/Account/Login"

<div class="container-fluid d-flex justify-content-center align-items-center vh-100">
    <div class="row justify-content-center">
		
            <EditForm Model="LoginModel" method="post" OnValidSubmit="LoginAsync" FormName="login" Enhance>
                <div class="card border-primary shadow-lg text-dark p-5" style="border-radius: 24px; min-width: 300px;">
                    <div class="card-header text-dark fs-4 border-primary">Login</div>
                    <div class="card-body">
                        <DataAnnotationsValidator />

                        <div class="mb-3">
                            <label for="email" class="form-label">Email Address</label>
                            <InputText id="email" @bind-Value="LoginModel.Email" class="form-control" autocomplete="username" />
                        </div>

                        <div class="mb-3">
                            <label for="password" class="form-label">Password</label>
                            <InputText id="password" type="password" @bind-Value="LoginModel.Password" class="form-control" autocomplete="current-password" />
                        </div>

                        <div class="mb-3">
                            <button class="btn btn-success w-100">Login</button>
                        </div>

                        <hr class="text-primary" />

                        <div class="text-center">
                            <a href="Account/Register" class="text-decoration-none">New? Register</a>
                            
                        </div>
                        <div class="text-center">
                            <a href="app/home" class="text-decoration-none">View Blogs</a>
                        </div>
                    </div>

                    <div class="card-footer mt-3">
                        @if (!string.IsNullOrEmpty(ErrorMessage))
                        {
                            <div class="alert alert-danger">@ErrorMessage</div>
                        }
                        else
                        {
                            <ValidationSummary class="text-danger" />
                        }
                    </div>
                </div>
            </EditForm>
    </div>
</div>


@code{
    string ErrorMessage = "";
    public bool IsBusy { get; set; } =false;
    [SupplyParameterFromForm]
    private LoginUserRequestDTO LoginModel { get; set; } = new();
    private async Task LoginAsync()
    {
        if (IsBusy) return;
        ErrorMessage = "";
        IsBusy = true;
        var response = await accountService.LoginAsync(LoginModel);
        if (!response.Flag)
        {
            IsBusy = false;
            ErrorMessage = response.Message;
            return;
        }
        IsBusy = false;
        NavManager.NavigateTo( "/app/home", true);
    }

    [CascadingParameter]
    public Task<AuthenticationState> ClientAuthState { get; set; }
    protected override async Task OnInitializedAsync()
    {
        if (ClientAuthState != null)
        {
       
            if ((await ClientAuthState!).User.Identity!.IsAuthenticated == true)
            {
                NavManager.NavigateTo("/app/home", false, true);
            }
        }
           
       
    }



}
